#!/bin/bash

#Shopcode

[ "`podman image ls -q`" == "" ] && echo "No image available. Build image first." && exit 0

OS=rhel
POSTYPE=rti
[ "$POSTYPE" == "rti" ] && VER="16" && POSDIR="usr2"
SHOPCODE="`cat .shopcode`"

[ "`podman container ls | grep $SHOPCODE`" != "" ] && echo "Container already running for $SHOPCODE." && exit 0

#add POS users
useradd -b /home tfpos-$SHOPCODE
mkdir /home/tfpos-$SHOPCODE/usr2

#start container
CONTAINER=`podman run -d -it -h $SHOPCODE.teleflora.com --name=$SHOPCODE.teleflora.com --rm --privileged -v "/home/tfpos-${SHOPCODE}/${POSDIR}:/${POSDIR}" -v /sys/fs/cgroup:/sys/fs/cgroup:ro -w="/${POSDIR}" -i ${OS}8-${POSTYPE} /usr/sbin/init`

echo $CONTAINER>.$SHOPCODE.container

#import yum repo gpg key
podman exec $CONTAINER rpm --import http://rhel8repo.centralus.cloudapp.azure.com/rhel-8-for-x86_64-baseos-rpms/RPM-GPG-KEY-redhat-release

#disable subscription manager
podman exec $CONTAINER sed -i 's/enabled=1/enabled=0/g' /etc/yum/pluginconf.d/subscription-manager.conf

#copy media to container
[ "$POSTYPE" == "rti" ] && cp ../files/ostools*.gz /home/tfpos-$SHOPCODE/$POSDIR/. && cp ../files/register_insights /home/tfpos-$SHOPCODE/$POSDIR/.

#Make loop back device in container so we can mount isos inside the container
podman exec $CONTAINER mknod /dev/loop b 7 0
podman exec $CONTAINER mkdir /boot

#unmask services
podman exec $CONTAINER systemctl unmask systemd-logind.service
podman exec $CONTAINER systemctl unmask console-getty.service
podman exec $CONTAINER systemctl unmask systemd-remount-fs.service
podman exec $CONTAINER systemctl unmask systemd-timedated.service
podman exec $CONTAINER systemctl unmask sys-fs-fuse-connections.mount
podman exec $CONTAINER systemctl unmask getty.target
podman exec $CONTAINER systemctl start systemd-logind.service

#install ostools
podman exec $CONTAINER updateos rh8 install_ostools-1.16

#install rti
podman exec $CONTAINER touch /etc/samba/smbusers 
podman exec $CONTAINER updateos rh8 conf_platform
podman exec $CONTAINER updateos rh8 conf_users
podman exec $CONTAINER updateos rh8 install_rti
podman exec $CONTAINER updateos rh8 install_tcc
podman exec $CONTAINER updateos rh8 harden_system
podman exec $CONTAINER updateos rh8 system_auth
podman exec $CONTAINER systemctl start rti 

#set samba passwords
podman exec -it $CONTAINER updateos rh8 smb_passwords

#register with insights.
podman exec $CONTAINER updateos rh8 register_insights

#restore backup data if exist.
[ "`ls /backups | grep $SHOPCODE`" != "" ] && ./restore_data $POSDIR

#install receipt printer drivers
podman cp ./istar.ppd ${CONTAINER}:/etc/cups/ppd
podman cp ./istar.rpm ${CONTAINER}:/tmp
podman exec $CONTAINER rpm -i /tmp/istar.rpm

#create vpn if desired
#echo -n "Create VPN? (y/n): "
#read VPN

#Done
echo "---"
echo "${OS}8-$POSTYPE-$SHOPCODE instance is ready!"
echo "---"
exit 0
