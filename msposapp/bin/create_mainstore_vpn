#!/bin/bash

# verify root
ID=`/usr/bin/id -u`
[ $ID -ne 0 ] && echo "You must be root to run $0." && exit 1

# check for running container
if [ -f ./.container ]; then
  CONTAINER="`cat .container`"
else
  echo "No Running Container!"
  exit 1
fi

# gather user input
INPUTS="SHOPCODE LOCATION_NAME POS_CLOUD_NETWORK MAINSTORE_PUBLIC MAINSTORE_NET PRESHAREDKEY"
POS_CLOUD_PUBLIC=`wget -qO- http://ipv4.icanhazip.com`

echo "Gathering required information...."
for var in $INPUTS; do
  echo -n "Enter $var: "
  read REPLY
  export $var=$REPLY
done

# verify input
if [ "$INPUTS" != "" ]; then
echo "ipsec VPN Connection about to be created:"
echo "--------------------"
echo "Continue y/n?"
read -p ""
if [ $REPLY == "n" ]; then
  exit 1
else
# configure strongSwan
echo "Creating VPN Connection......"
cat >> ipsec.conf <<EOF
# ipsec.conf - strongSwan IPsec configuration file

# basic configuration
config setup
        charondebug="all"
        uniqueids=yes
        strictcrlpolicy=no

# connection to $LOCATION_NAME
conn $LOCATION_NAME
  keyexchange=ikev1
  authby=secret
  left=%defaultroute
  leftid=${POS_CLOUD_PUBLIC}
  leftsubnet="${POS_CLOUD_NETWORK}/24"
  right=${MAINSTORE_PUBLIC}
  rightsubnet="${MAINSTORE_NET}/24"
  ike=aes128-sha1-modp1024!
  esp=aes128-sha1-modp1024!
  keyingtries=0
  ikelifetime=1h
  lifetime=8h
  dpddelay=30
  dpdtimeout=120
  dpdaction=restart
  auto=start
EOF

cat >> ipsec.secrets <<EOF
# ipsec.secrets - strongSwan IPsec secrets file
# source destination secret
${POS_CLOUD_PUBLIC} ${MAINSTORE_PUBLIC} : PSK "${PRESHAREDKEY}"
EOF

# set passphrase file perms
chmod 600 ipsec.secrets

# copy produced config files to container
docker cp ipsec.conf "${CONTAINER}:/etc/strongswan/ipsec.conf"
docker cp ipsec.secrets "${CONTAINER}:/etc/strongswan/ipsec.secrets"

echo "VPN Connection Created."
fi
else
echo "Nothing to do."
fi
exit 0
