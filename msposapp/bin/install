#!/usr/bin/bash

HOST_USER=`whoami`

#verify root
[ $ID -ne 0 ] && echo "You must be root or in sudoers to run $0." && exit 1

#Environment Name 
[ ! -f ../../.envtype ] && echo -n "Env Name: " && read ENVTYPE && echo "$ENVTYPE" >../../.envtype
#Shopcode
[ ! -f .shopcode ] && echo -n "Shopcode: " && read SHOPCODE && echo "$SHOPCODE" >.shopcode

#set selinux to permissive
setenforce 0
sed -i 's/SELINUX=enforcing/SELINUX=permissive/g' /etc/selinux/config

#disable subscription manager.
sed -i "s/enabled=1/enabled=0/g" /etc/yum/pluginconf.d/subscription-manager.conf

#install required packages
yum clean all
yum -y install net-tools gtk3 ksh wget firewalld tigervnc-server-minimal mailx nmap time podman device-mapper-libs device-mapper-event-libs chrony lorax anaconda-tui unzip expect

# set timezone
timedatectl set-timezone America/Chicago

#ip port forwarding
[ "`grep net.ipv4.ip_forward /etc/sysctl.conf`" == "" ] &&  echo "net.ipv4.ip_forward = 1">>/etc/sysctl.conf &&  sysctl -p /etc/sysctl.conf && systemctl restart network.service
[ "`grep net.ipv4.conf.all.accept_redirects /etc/sysctl.conf`" == "" ] &&  echo "net.ipv4.conf.all.accept_redirects = 0">>/etc/sysctl.conf &&  sysctl -p /etc/sysctl.conf && systemctl restart network.service
[ "`grep net.ipv4.conf.all.send_redirects /etc/sysctl.conf`" == "" ] &&  echo "net.ipv4.conf.all.send_redirects = 0">>/etc/sysctl.conf &&  sysctl -p /etc/sysctl.conf && systemctl restart network.service

#copy in port forwrd config for docker
cp -f ./99-docker.conf /usr/lib/sysctl.d/99-podman.conf

# add tfsupport usr and generate keys folder, if not there.
#[ ! -d /home/tfsupport ] && useradd tfsupport
#[ ! -d /home/tfsupport/keys ] && mkdir /home/tfsupport/keys && chown tfsupport:tfsupport /home/tfsupport/keys

# Add tfsupport to sudoers, if not there.
#[ "`grep tfsupport /etc/sudoers`" == "" ] && echo "tfsupport        ALL=(ALL)       NOPASSWD: ALL">>/etc/sudoers

# lastly, update everything
yum -y update

# create base image
echo -n "Create base image? y/n: "
read answer
[ "$answer" == "n" ] && echo "Done." && exit 0
podman rmi $(podman images -a -q) -f 2>/dev/null
./create-image
 
echo "Done!"

exit 0
