#!/bin/bash

[ ! -f ./.container ] && echo No running container! && exit
POS_DIR=$1
[ "$POS_DIR" == "d" ] && POS_USER=daisy
[ "$POS_DIR" == "usr2" ] && POS_USER=rti

CONTAINER=`cat .container`
SHOPCODE=`cat .shopcode`

echo ""
echo "Data Restoration"
echo "================"
[ "`ls /backups | grep $SHOPCODE | wc -l`" != "0" ] && echo -n "Restore data? " && read REPLY

[ "$REPLY" == "y" ] && [ "`ls /backups | grep $SHOPCODE | wc -l`" != "1" ] && echo "" && echo "`ls /backups | grep $SHOPCODE | cut -d- -f3`" && echo "" && echo -n "Which? " && read BACKUP_SUB && BACKUP_NAME="-$BACKUP_SUB"
[ "$REPLY" == "y" ] && [ "`ls /backups | grep $SHOPCODE | wc -l`" == "1" ] && BACKUP_NAME=""
[ "$REPLY" != "y" ] && BACKUP_DIR="" || BACKUP_DIR="/backups/tfrsync-$SHOPCODE$BACKUP_NAME"

echo ""
echo From: $BACKUP_DIR
echo To  : /home/tfpos-$SHOPCODE/
echo ""
sleep 3

[ "$BACKUP_DIR" != "" ] && rsync -avzh $BACKUP_DIR/. /home/tfpos-$SHOPCODE/ && docker exec $CONTAINER chown -R $POS_USER:$POS_USER /$POS_DIR
[ -d /home/tfpos-$SHOPCODE/etc ] && mv /home/tfpos-$SHOPCODE/etc /home/tfpos-$SHOPCODE/$POS_DIR/. && docker exec $CONTAINER rsync -avhz /$POS_DIR/etc / && docker exec $CONTAINER chown -R root:root /etc 
[ -d /home/tfpos-$SHOPCODE/home ] && mv /home/tfpos-$SHOPCODE/home /home/tfpos-$SHOPCODE/$POS_DIR/. && docker exec $CONTAINER rsync -avhz /$POS_DIR/home / && docker exec $CONTAINER chown -R tfsupport /home/tfsupport
[ -d /home/tfpos-$SHOPCODE/usr/java ] && mv /home/tfpos-$SHOPCODE/usr/java /home/tfpos-$SHOPCODE/$POS_DIR/. && docker exec $CONTAINER rsync -avhz /$POS_DIR/java /usr/ && docker exec $CONTAINER chown -R root:root /usr/java
docker exec $CONTAINER chown root:root /etc/sudoers
