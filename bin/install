#!/usr/bin/bash
#RHEL7 required! 
 
#register rhsm
#subscription-manager register 
#subscription-manager auto-attach
 
#enable redhat yum repos
subscription-manager repos --enable=rhel-7-server-rpms 
subscription-manager repos --enable=rhel-7-server-extras-rpms
subscription-manager repos --enable=rhel-7-server-optional-rpms 
subscription-manager repos --enable=rhel-server-rhscl-7-rpms

# install ntp
yum -y install ntp
# sync date/time otherwise AWS auth will fail
ntpdate pool.ntp.org
 
#install required packages
yum -y install net-tools yum-langpacks gtk3 python27-python-pip ksh wget firewalld tigervnc-server-minimal mailx nmap
yum -y install nfs-utils libnfsidmap
systemctl enable rpcbind
systemctl enable nfs-server
systemctl start rpcbind
systemctl start nfs-server
systemctl start rpc-statd

#add env awareness of pip and aws at login
echo "source scl_source enable python27">/etc/profile.d/enablepython27.sh

#install docker
yum -y install docker device-mapper-libs device-mapper-event-libs
#add redhat container registry
echo "ADD_REGISTRY='--add-registry registry.access.redhat.com'">>/etc/sysconfig/docker
systemctl start docker
systemctl enable docker

#add docker sshfs plugin
cd /usr/libexec/docker/
ln -s docker-runc-current docker-runc
cd -
docker plugin install --grant-all-permissions vieux/sshfs

#createcontainer.sh reqs
yum -y install lorax
yum -y install anaconda-tui

# add custom scripts to /usr/local/bin
find . -name "*monthname.sh" -exec cp -f {} /usr/local/bin/. \;
find . -name "*recon.sh" -exec cp -f {} /usr/local/bin/. \;

# record ssh sessions
cat << xxxEOFxxx > /etc/profile.d/record_sessions.sh
if [ ! -d /var/log/session ]
then
mkdir /var/log/session
fi
if [ "x$SESSION_RECORD" = "x" ]
then
timestamp=`date "+%m%d%Y%H%M"`
output=/var/log/session/session.$USER.$$.$timestamp
SESSION_RECORD=started
export SESSION_RECORD
script -t -f -q 2>${output}.timing $output
exit
fi
xxxEOFxxx

# lastly, update everything
yum -y update

echo "Done!"
exit 0
